clearvars
close all

load('MIMO_para.mat')

Ad = lin_discrete.A;
Bd = lin_discrete.B;
Cd = lin_discrete.C;
Dd = lin_discrete.D;

Ac = lin_statespace.A;
Bc = lin_statespace.B;
Cc = lin_statespace.C;
Dc = lin_statespace.D;

%% controllability test

Co = ctrb(Ad,Bd);

rankcheck = rank(Co);

if rankcheck == min(size(Co))
    display('System is controllable');
else
    display('System is NOT controllable');
end


%%

%P = [pole(lin_statespace)]';
P = [-0.0626 -.0626 -0.009 -0.027];
K = place(Ac,Bc,P);
% Q = eye(min(size(Ac)));

newsys = ss(Ac-Bc*K,Bc,Cc,Dc);

MIMO = tf(newsys(1:2,1:2));

figure(1)
step(MIMO)

% figure(2)
% step(lin_statespace)

Kdc = dcgain(MIMO);
Kr = inv(Kdc);

MIMO_scaled = ss(Ac-Bc*K,Bc*Kr,Cc,Dc);

figure(3)
step(MIMO_scaled)

%% design observer 

[Kest,L,P2] = kalman(MIMO_scaled,[],[],[]);

kalmansys_discr = c2d(Kest,1);
figure(4)
bode(MIMO_scaled)

figure(5)
bode(lin_statespace)



%%

figure(1)
pzmap(lin_discrete)

figure(2)
pzmap(lin_statespace)

figure(3)
step(lin_statespace)

P = [pole(lin_statespace)]';
K = place(Ac,Bc,P);

G = tf(lin_statespace);
H = feedback(G,K);

%Acl = Ac - Bc*K;
%syscl = ss(Acl,Bc,Cc,Dc);

figure(4)
bode(lin_statespace)



%% Pole-placement

% Check open loop poles

P_OL = pole(lin_statespace);

% Make closed loop
figure(4)
step(lin_statespace)

% Solve for gain
Kdc = dcgain(lin_statespace);
Kr = inv(Kdc);

% Create scaled input CL system
syscl_scaled = ss(Ac,Bc*Kr,Cc,Dc);

figure(5)
step(syscl_scaled)










